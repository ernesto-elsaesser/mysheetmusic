<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Sheet Music</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.5/build/cjs/vexflow.js"></script>
    <script src="js/render.js#20250824"></script>
    <script src="js/transpose.js#20250824"></script>
    <script src="js/import.js#20250824"></script>
    <link rel="stylesheet" href="style.css#20250913" />
</head>

<body>

    <div id="title"></div>

    <button id="songs" class="lbtn" onclick="showSongs()">SONGS</button>
    <button id="reset" class="lbtn" onclick="resetSong()" hidden>RESET</button>
    <button id="save" class="rbtn" onclick="saveSong()" hidden>SAVE</button>
    <button id="tabs" class="rbtn" onclick="showTabs()">MENU</button>

    <div id="content">
        <div id="sheet" class="tab"></div>
        <div id="raw" class="tab" hidden>
            <input type="button" onclick="shiftSong(-7)" value="OCTAVE DOWN">
            <input type="button" onclick="shiftSong(7)" value="OCTAVE UP">
            <input type="button" onclick="shiftSong(-1)" value="STEP DOWN">
            <input type="button" onclick="shiftSong(1)" value="STEP UP">
            <textarea id="code"></textarea>
        </div>
        <div id="create" class="tab" hidden>
            <form>
                <label for="name">Title:</label> <input type="text" id="name" size=32>
                <input type="button" onclick="createSong()" value="Create">
            </form>
        </div>
        <div id="import" class="tab" hidden>
            <form>
                <label for="file">MusicXML Import:</label><br/><br/>
                <input type="file" id="file" accept=".mxl"><br/><br/>
                <label for="filename">Title:</label> <input type="text" id="filename" size=32>
                <p>Select which part to import:</p>
                <div id="parts"></div>
            </form>
        </div>
        <div id="delete" class="tab" hidden>
            <form>
                <p>Do you really want to delete this song?</p>
                <input type="button" onclick="deleteSong()" value="Delete">
            </form>
        </div>
    </div>
    </div>

    <div id="verses"></div>

    <div id="songmenu" class="menu" hidden></div>
    <div id="tabmenu" class="menu" hidden>
        <button class="tabbtn" onclick="selectTab('sheet')">Sheet Music</button>
        <button class="tabbtn" onclick="selectTab('raw')">Text Editor</button>
        <button class="tabbtn" onclick="selectTab('create')">Create Song</button>
        <button class="tabbtn" onclick="selectTab('import')">MusicXML Import</button>
        <button class="tabbtn" onclick="selectTab('delete')">Delete Song</button>
        <button class="tabbtn" onclick="reloadSongs()">Reload Songs</button>
    </div>

    <script>

        const title = document.getElementById('title')
        const content = document.getElementById('content')
        const songButton = document.getElementById('songs')
        const resetButton = document.getElementById('reset')
        const saveButton = document.getElementById('save')
        const tabButton = document.getElementById('tabs')
        const sheet = document.getElementById('sheet')
        const raw = document.getElementById('raw')
        const code = document.getElementById('code')
        const nameInput = document.getElementById('name')
        const fileNameInput = document.getElementById('filename')
        const fileInput = document.getElementById('file')
        const parts = document.getElementById('parts')
        const verses = document.getElementById('verses')
        const songMenu = document.getElementById('songmenu')
        const tabMenu = document.getElementById('tabmenu')

        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches

        var songs = {}

        async function loadSongs() {

            const res = await fetch("songs.php")

            if (res.status != 200) {
                window.alert(res.statusText)
                return
            }

            songs = await res.json()

            songMenu.innerHTML = ""

            const names = Object.keys(songs).sort()

            let initial = ""
            for (const name of names) {
                let button = document.createElement('button')
                button.innerText = name
                button.className = "songbtn"
                button.onclick = () => selectSong(name)
                if (name[0] != initial) {
                    button.style.clear = "both"
                    initial = name[0]
                }
                songMenu.appendChild(button)
            }

            return names
        }

        async function reloadSongs() {

            const names = await loadSongs()
            let selected = decodeURIComponent(window.location.hash.slice(1))
            if (!names.includes(selected)) selected = names[0]
            loadSong(selected)
        }

        function showTabs() {

            tabMenu.hidden = !tabMenu.hidden
            songMenu.hidden = true
            content.hidden = !tabMenu.hidden
        }

        function selectTab(tabId) {

            const tabs = document.getElementsByClassName("tab")
            for (let tab of tabs) {
                tab.hidden = tab.id != tabId
            }
            tabMenu.hidden = true
            content.hidden = false
            verses.hidden = tabId != "sheet"
        }

        function showSongs() {

            songMenu.hidden = !songMenu.hidden
            tabMenu.hidden = true
            content.hidden = !songMenu.hidden
        }

        function selectSong(name) {

            songMenu.hidden = true
            content.hidden = false

            loadSong(name)
        }

        function loadSong(name) {

            window.location.hash = "#" + name
            title.innerText = name
            sheet.innerHTML = ""
            verses.innerHTML = ""

            code.value = songs[name]
            const parts = code.value.replaceAll("\n\n~", "*\n\n~").split("\n\n")

            let measures = []
            let verseCount = 1

            for (let part of parts) {
                if (part == "") continue

                let tieEnd = false
                if (part.slice(-1) == "*") {
                    tieEnd = true
                    part = part.slice(0, -1)
                }

                let lines = part.split("\n")
                const lengths = lines.map((l) => l.length)
                const maxLength = Math.max(...lengths)

                const melody = lines.shift()
                const text = lines.join("\n")
                if (lines.length > verseCount) verseCount = lines.length

                let measure = document.createElement("div")
                measure.className = "measure"

                let frame = document.createElement("div")
                frame.className = "frame"
                measure.appendChild(frame)

                let rawtext = document.createElement("textarea")
                rawtext.className = "code"
                rawtext.value = melody
                rawtext.hidden = true
                measure.appendChild(rawtext)

                let lyrics = document.createElement("textarea")
                lyrics.className = "lyrics"
                lyrics.value = text
                measure.appendChild(lyrics)

                let render = () => {
                    const length = Math.max(maxLength, rawtext.value.length)
                    const width = Math.max((length + 1) * 8, 40)
                    measure.style.width = width.toString() + "px"
                    try {
                        renderMeasure(frame, isDark, width, rawtext.value, tieEnd)
                    } catch (error) {
                        console.log(error)
                        frame.innerText = error.toString()
                        frame.style.color = "red"
                    }
                }

                render()

                rawtext.oninput = () => toggleEditMode(true)
                lyrics.oninput = () => toggleEditMode(true)

                frame.onclick = () => {
                    if (rawtext.hidden) {
                        rawtext.hidden = false
                        lyrics.hidden = true
                    } else {
                        rawtext.hidden = true
                        lyrics.hidden = false
                        render()
                    }
                }

                measures.push(measure)
            }

            sheet.replaceChildren(...measures)

            if (verseCount == 1) return

            for (let i = 0; i < verseCount; i += 1) {
                const button = document.createElement("button")
                button.innerText = (i + 1).toString()
                button.onclick = () => scrollLyrics(i)
                verses.appendChild(button)
            }
        }

        function scrollLyrics(index) {

            const textareas = document.getElementsByClassName("lyrics")
            for (let textarea of textareas) {
                textarea.scrollTop = index * 16
            }
        }

        function toggleEditMode(edit) {

            songButton.hidden = edit
            resetButton.hidden = !edit
            saveButton.hidden = !edit
            tabButton.hidden = edit
        }

        function resetSong() {

            const name = title.innerText
            if (name in songs) {
                loadSong(name)
                toggleEditMode(false)
            } else {
                code.value = ""
            }
        }

        async function saveSong() {

            const name = title.innerText

            let data
            if (sheet.hidden) {
                data = code.value
            } else {
                const measures = document.getElementsByClassName("measure")
                const parts = Array.from(measures).map((m) => {
                    let melody = m.childNodes[1].value
                    let text = m.childNodes[2].value
                    return text ? melody + "\n" + text : melody
                })
                data = parts.join("\n\n")
            }

            const res = await fetch('songs.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: "name=" + name + "&data=" + data
            })

            if (res.status != 200) {
                window.alert(res.statusText)
                return
            }

            toggleEditMode(false)

            await loadSongs()

            loadSong(name)
        }

        fileInput.addEventListener('change', (event) => {

            const file = event.target.files[0]
            if (file == null) return

            fileNameInput.value = file.name.split(".")[0].replaceAll("_", " ")
            parts.innerHTML = ""

            const parser = new DOMParser()
            const reader = new FileReader()
            reader.onload = async (event) => {
                const array = new Uint8Array(event.target.result)
                const rawReader = new zip.Uint8ArrayReader(array)
                const reader = new zip.ZipReader(rawReader)
                const entries = await reader.getEntries()
                for (let entry of entries) {
                    if (entry.filename.startsWith("META-INF")) continue
                    const writer = new zip.TextWriter()
                    const xml = await entry.getData(writer)
                    const doc = parser.parseFromString(xml, "text/xml")
                    const eparts = doc.getElementsByTagName("part")
                    for (let epart of eparts) {
                        const button = document.createElement("button")
                        button.innerText = epart.id
                        button.onclick = () => importSong(epart)
                        parts.appendChild(button)
                    }
                }
                await reader.close()
            }
            reader.onerror = () => {
                window.alert("Failed to parse " + file.name)
            }
            reader.readAsArrayBuffer(file)
        })

        function createSong() {

            title.innerText = nameInput.value
            nameInput.value = ""
            code.value = ""
            selectTab("raw")
            toggleEditMode(true)
        }

        function importSong(epart) {

            title.innerText = fileNameInput.value
            fileNameInput.value = ""
            parts.innerHTML = ""
            code.value = extractCode(epart, "1")
            selectTab("raw")
            toggleEditMode(true)
        }

        function shiftSong(steps) {

            code.value = transposeCode(code.value, steps)
            toggleEditMode(true)
        }

        async function deleteSong() {

            const name = title.innerText

            const res = await fetch('songs.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: "name=" + name
            })

            if (res.status != 200) {
                window.alert(res.statusText)
                return
            }

            selectTab("sheet")

            const names = await loadSongs()
            loadSong(names[0])
        }

        code.oninput = () => toggleEditMode(true)
        
        reloadSongs()

    </script>
    <script src="js/zip.js"></script>
</body>
</html>