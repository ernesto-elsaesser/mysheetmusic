<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Sheet Music</title>
    <link rel="stylesheet" href="style.css?v=20250205" />
</head>

<body>
    <div id="header">
        <select id="picker" onchange="select()"
            style="margin: 0 5px; height: 32px; width: 200px; border: 0; outline: none;">
            <option>Loading ...</option>
        </select><button id="edit" class="menu" onclick="edit()" hidden>EDIT</button><button id="revert" class="menu"
            onclick="select()" hidden>REVERT</button><button id="save" class="menu" onclick="save()"
            hidden>SAVE</button>
    </div>
    <div id="editor">
        <textarea id="data"></textarea>
        <div class="pad">
            <button class="add" onclick="add('A3/1')">A3</button><button class="add"
                onclick="add('A3/2')">2</button><button class="add" onclick="add('A3/4')">4</button><button class="add"
                onclick="add('A3/8')">8</button><button class="add" onclick="add('A3/16')">16</button><br />
            <button class="add" onclick="add('B3/1')">B3</button><button class="add"
                onclick="add('B3/2')">2</button><button class="add" onclick="add('B3/4')">4</button><button class="add"
                onclick="add('B3/8')">8</button><button class="add" onclick="add('B3/16')">16</button><br />
            <button class="add" onclick="add('C4/1')">C4</button><button class="add"
                onclick="add('C4/2')">2</button><button class="add" onclick="add('C4/4')">4</button><button class="add"
                onclick="add('C4/8')">8</button><button class="add" onclick="add('C4/16')">16</button><br />
            <button class="add" onclick="add('D4/1')">D4</button><button class="add"
                onclick="add('D4/2')">2</button><button class="add" onclick="add('D4/4')">4</button><button class="add"
                onclick="add('D4/8')">8</button><button class="add" onclick="add('D4/16')">16</button><br />
            <button class="add" onclick="add('E4/1')">E4</button><button class="add"
                onclick="add('E4/2')">2</button><button class="add" onclick="add('E4/4')">4</button><button class="add"
                onclick="add('E4/8')">8</button><button class="add" onclick="add('E4/16')">16</button><br />
            <button class="add" onclick="add('F4/1')">F4</button><button class="add"
                onclick="add('F4/2')">2</button><button class="add" onclick="add('F4/4')">4</button><button class="add"
                onclick="add('F4/8')">8</button><button class="add" onclick="add('F4/16')">16</button><br />
            <button class="add" onclick="add('G4/1')">G4</button><button class="add"
                onclick="add('G4/2')">2</button><button class="add" onclick="add('G4/4')">4</button><button class="add"
                onclick="add('G4/8')">8</button><button class="add" onclick="add('G4/16')">16</button><br />
            <button class="add" onclick="add('A4/1')">A4</button><button class="add"
                onclick="add('A4/2')">2</button><button class="add" onclick="add('A4/4')">4</button><button class="add"
                onclick="add('A4/8')">8</button><button class="add" onclick="add('A4/16')">16</button><br />
            <button class="add" onclick="add('B4/1')">B4</button><button class="add"
                onclick="add('B4/2')">2</button><button class="add" onclick="add('B4/4')">4</button><button class="add"
                onclick="add('B4/8')">8</button><button class="add" onclick="add('B4/16')">16</button>
        </div>
        <div class="pad">
            <button class="add" onclick="del()">X</button><button class="add" onclick="dot()">&bull;</button><button
                class="add" onclick="tie()">~</button><button class="add wide" onclick="render()">DISPLAY</button><br />
            <button class="add" onclick="add('B4/1/r')">R</button><button class="add"
                onclick="add('B4/2/r')">2</button><button class="add" onclick="add('B4/4/r')">4</button><button
                class="add" onclick="add('B4/8/r')">8</button><button class="add"
                onclick="add('B4/16/r')">16</button><br />
            <button class="add" onclick="add('C5/1')">C5</button><button class="add"
                onclick="add('C5/2')">2</button><button class="add" onclick="add('C5/4')">4</button><button class="add"
                onclick="add('C5/8')">8</button><button class="add" onclick="add('C5/16')">16</button><br />
            <button class="add" onclick="add('D5/1')">D5</button><button class="add"
                onclick="add('D5/2')">2</button><button class="add" onclick="add('D5/4')">4</button><button class="add"
                onclick="add('D5/8')">8</button><button class="add" onclick="add('D5/16')">16</button><br />
            <button class="add" onclick="add('E5/1')">E5</button><button class="add"
                onclick="add('E5/2')">2</button><button class="add" onclick="add('E5/4')">4</button><button class="add"
                onclick="add('E5/8')">8</button><button class="add" onclick="add('E5/16')">16</button><br />
            <button class="add" onclick="add('F5/1')">F5</button><button class="add"
                onclick="add('F5/2')">2</button><button class="add" onclick="add('F5/4')">4</button><button class="add"
                onclick="add('F5/8')">8</button><button class="add" onclick="add('F5/16')">16</button><br />
            <button class="add" onclick="add('G5/1')">G5</button><button class="add"
                onclick="add('G5/2')">2</button><button class="add" onclick="add('G5/4')">4</button><button class="add"
                onclick="add('G5/8')">8</button><button class="add" onclick="add('G5/16')">16</button><br />
            <button class="add" onclick="add('A5/1')">A5</button><button class="add"
                onclick="add('A5/2')">2</button><button class="add" onclick="add('A5/4')">4</button><button class="add"
                onclick="add('A5/8')">8</button><button class="add" onclick="add('A5/16')">16</button><br />
            <button class="add" onclick="add('B5/1')">B5</button><button class="add"
                onclick="add('B5/2')">2</button><button class="add" onclick="add('B5/4')">4</button><button class="add"
                onclick="add('B5/8')">8</button><button class="add" onclick="add('B5/16')">16</button>
        </div>
        <div class="clear"></div>
    </div>
    <div id="sheet"></div>
    <div class="clear"></div>
    <script src="https://cdn.jsdelivr.net/npm/vexflow/build/cjs/vexflow.js"></script>
    <script src="render.js?v=20250216"></script>
    <script src="edit.js?v=20250216"></script>
    <script>

        const NEW = "< New Song >"

        let picker = document.getElementById('picker')
        let editButton = document.getElementById('edit')
        let revertButton = document.getElementById('revert')
        let saveButton = document.getElementById('save')
        let editor = document.getElementById('editor')
        let textarea = document.getElementById('data')
        let sheet = document.getElementById('sheet')

        var songs = {}
        var current = NEW

        async function load(res) {

            if (res.status > 201) {
                window.alert(res.statusText)
                return
            }

            songs = await res.json()
            songs[NEW] = "\n"

            let names = Object.keys(songs).sort()
            build(names, current)

            select()
        }

        function build(names, selected) {

            picker.innerHTML = ""

            for (let name of names) {
                let option = document.createElement('option')
                option.value = name
                option.innerText = name
                option.selected = name == selected
                picker.appendChild(option)
            }
        }

        function select() {

            current = picker.value
            document.title = "Song: " + current
            textarea.value = songs[current]
            let isNew = current == NEW
            editButton.hidden = isNew
            revertButton.hidden = true
            saveButton.hidden = !isNew
            editor.hidden = !isNew
            render()
        }

        function render() {
            renderSong(textarea, sheet)
        }

        function edit() {
            editButton.hidden = true
            revertButton.hidden = false
            saveButton.hidden = false
            editor.hidden = false
        }

        function add(note) {
            addNote(textarea, note)
        }

        function dot() {
            dotNote(textarea)
        }

        function tie() {
            tieNote(textarea)
        }

        function del() {
            deleteNote(textarea)
        }

        async function save() {

            if (current == NEW) current = prompt("Song name:")
            if (current == null) return

            build(["Saving ..."])

            let res = await fetch('songs.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: "name=" + current + "&data=" + textarea.value
            })

            load(res)
        }

        fetch("songs.php").then(load)

    </script>
</body>

</html>