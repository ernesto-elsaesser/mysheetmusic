<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Sheet Music</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.5/build/cjs/vexflow.js"></script>
    <script src="render.js?v=20250418"></script>
    <link rel="stylesheet" href="style.css?v=20250418" />
</head>

<body>

    <div id="toolbar">
        <select id="song" class="toolbar" onchange="selectSong()">
            <option>Loading ...</option>
        </select>
        <select id="part" class="toolbar" onchange="selectPart()">
        </select>
        <button id="edit" onclick="edit()" hidden>EDIT</button>
        <button id="revert" class="menu" onclick="select()" hidden>ABORT</button>
        <button id="save" onclick="save()" hidden>SAVE</button>
    </div>

    <div id="content">
        <textarea id="editor"></textarea>
        <div id="sheet"></div>
    </div>

    <script>

        let songSelect = document.getElementById('song')
        let partSelect = document.getElementById('part')
        let editButton = document.getElementById('edit')
        let revertButton = document.getElementById('revert')
        let saveButton = document.getElementById('save')
        let editor = document.getElementById('editor')
        let sheet = document.getElementById('sheet')

        var songs = {}
        var parts = {}

        async function load(res) {

            if (res.status > 201) {
                build(["ERROR"])
                window.alert(res.statusText)
                return
            }

            songs = await res.json()

            songSelect.innerHTML = ""

            const names = [...Object.keys(songs.txt), ...Object.keys(songs.xml)]

            names.sort().forEach((name) => {
                let option = document.createElement('option')
                option.value = name
                option.innerText = name
                // TODO select anchor
                option.selected = name == names[0]
                songSelect.appendChild(option)
            })

            selectSong()
        }

        function selectSong() {

            editButton.hidden = false
            revertButton.hidden = true
            saveButton.hidden = true
            editor.hidden = true

            const name = songSelect.value
            const xml = songs.xml[name]
            if (xml) parts = parseXML(xml)
            else parts = {"P1": songs.txt[name]}

            partSelect.innerHTML = ""

            // TODO option for each verse
            const partIds = Object.keys(parts)
            partIds.forEach((partId) => {
                let option = document.createElement('option')
                option.value = partId
                option.innerText = partId
                option.selected = partId == partIds[0]
                partSelect.appendChild(option)
            })

            selectPart()
        }

        function selectPart() {

            const partId = partSelect.value
            const code = parts[partId]
            editor.value = code

            let dark = window.matchMedia('(prefers-color-scheme: dark)').matches
            let color = dark ? "white" : "black"

            renderPart(code, 1, sheet, color)
        }

        function edit() {

            editButton.hidden = true
            revertButton.hidden = false
            saveButton.hidden = false
            editor.hidden = false
        }

        async function save() {

            const name = songSelect.value
            const res = await fetch('songs.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: "name=" + current + "&data=" + code.value
            })

            load(res)
        }

        fetch("songs.php").then(load)

    </script>
</body>

</html>